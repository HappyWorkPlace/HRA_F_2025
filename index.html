<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>HRA Cinema Club - Welcome</title>
<style>
  :root {
    --bg: #0f172a;
    --card: #1e293b;
    --text: #f1f5f9;
    --muted: #64748b;
    --primary: #3b82f6; /* Modern Blue */
    --accent: #f43f5e;
    --success: #22c55e;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
  
  body {
    background-color: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background-image: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%);
  }

  .container {
    width: 100%;
    max-width: 400px;
    text-align: center;
  }

  /* Logo & Header */
  .logo { font-size: 3rem; margin-bottom: 10px; animation: float 3s ease-in-out infinite; }
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  
  h1 { font-size: 1.8rem; font-weight: 800; margin-bottom: 5px; background: linear-gradient(to right, #60a5fa, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  p.subtitle { color: var(--muted); font-size: 0.9rem; margin-bottom: 30px; }

  /* Card */
  .card {
    background: var(--card);
    padding: 30px;
    border-radius: 24px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.3s ease;
  }

  /* Form Elements */
  .form-group { margin-bottom: 20px; text-align: left; }
  label { display: block; font-size: 0.85rem; color: var(--muted); margin-bottom: 8px; font-weight: 600; }
  
  input {
    width: 100%;
    padding: 14px;
    background: #0f172a;
    border: 2px solid #334155;
    border-radius: 12px;
    color: white;
    font-size: 1rem;
    transition: 0.2s;
    outline: none;
  }
  
  input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }

  /* Buttons */
  .btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
  .btn-primary:active { transform: scale(0.98); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Loading */
  .loading-overlay {
    position: fixed; inset: 0; background: var(--bg); z-index: 99;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.5s;
  }
  .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* User Profile Preview */
  .profile-mini { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 50px; display: none; }
  .profile-mini img { width: 30px; height: 30px; border-radius: 50%; }
  .profile-mini span { font-size: 0.9rem; font-weight: 600; }

  .hidden { display: none !important; }
  .fade-out { opacity: 0; pointer-events: none; }
</style>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loadingPage" class="loading-overlay">
    <div class="spinner"></div>
    <div style="color: var(--muted); font-size: 0.9rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <div class="container">
    <div class="logo">üçø</div>
    <h1>HRA CINEMA</h1>
    <p class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ä‡∏°‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</p>

    <!-- Registration Form -->
    <div id="registerCard" class="card hidden">
      <div id="lineProfile" class="profile-mini">
        <img id="profileImg" src="" alt="">
        <span id="profileName">User</span>
      </div>

      <div class="form-group">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <input type="text" id="empNoInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô A1234)" autocomplete="off" onkeyup="this.value = this.value.toUpperCase()">
      </div>

      <button id="checkBtn" class="btn btn-primary" onclick="checkEmployee()">
        ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </button>
      <div id="msg" style="margin-top: 15px; font-size: 0.9rem; min-height: 20px;"></div>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2008529302-50MNLyDV'; // ‡πÉ‡∏ä‡πâ LIFF ID ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const API_URL = 'https://script.google.com/macros/s/AKfycbzDFe-UmxrioicKjQRQmha9XLmkBZlcpmRS2PstuwiynZmyWXlNOdpXGKYUSr2-UqOE/exec'; // API ‡πÄ‡∏î‡∏¥‡∏°

    let liffProfile = null;

    window.onload = async () => {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        
        liffProfile = await liff.getProfile();
        
        // Show basic profile
        document.getElementById('profileImg').src = liffProfile.pictureUrl || 'https://via.placeholder.com/30';
        document.getElementById('profileName').textContent = liffProfile.displayName;
        document.getElementById('lineProfile').style.display = 'flex';

        // Check if already registered
        const result = await fetch(`${API_URL}?action=checkRegistration&lineUserId=${liffProfile.userId}`).then(r => r.json());

        if (result.registered) {
          // Auto login
          saveSession(result.data, liffProfile);
          window.location.href = 'booking.html';
        } else {
          // Show Register Form
          document.getElementById('loadingPage').classList.add('fade-out');
          document.getElementById('registerCard').classList.remove('hidden');
        }

      } catch (err) {
        alert('Error: ' + err.message);
      }
    };

    async function checkEmployee() {
      const empNo = document.getElementById('empNoInput').value.trim();
      if (!empNo) return showMsg('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'red');

      setLoading(true);
      
      try {
        // 1. Get Employee Info
        const info = await fetch(`${API_URL}?action=getEmployeeInfo&empNo=${empNo}`).then(r => r.json());
        
        if (!info.success) {
          setLoading(false);
          return showMsg(info.message, '#f43f5e');
        }

        if (info.data.uid) {
           setLoading(false);
           return showMsg('‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', '#f43f5e');
        }

        // 2. Register
        if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô?\n‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${info.data.name}\n‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î: ${info.data.factory}`)) {
             const reg = await fetch(`${API_URL}?action=registerUser&empNo=${empNo}&lineUserId=${liffProfile.userId}&lineDisplayName=${liffProfile.displayName}&linePictureUrl=${liffProfile.pictureUrl}`).then(r => r.json());
             
             if (reg.success) {
               saveSession(reg.data, liffProfile);
               window.location.href = 'booking.html';
             } else {
               showMsg(reg.message, '#f43f5e');
               setLoading(false);
             }
        } else {
          setLoading(false);
        }

      } catch (err) {
        showMsg('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', '#f43f5e');
        setLoading(false);
      }
    }

    function saveSession(userParams, lineProfile) {
      const userData = {
        empNo: userParams.empNo,
        name: userParams.name,
        factory: userParams.factory,
        lineUserId: lineProfile.userId,
        linePictureUrl: lineProfile.pictureUrl
      };
      sessionStorage.setItem('userData', JSON.stringify(userData));
    }

    function setLoading(isLoading) {
      const btn = document.getElementById('checkBtn');
      btn.disabled = isLoading;
      btn.textContent = isLoading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...' : '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    }

    function showMsg(text, color) {
      const el = document.getElementById('msg');
      el.textContent = text;
      el.style.color = color;
    }
  </script>
</body>
</html>
