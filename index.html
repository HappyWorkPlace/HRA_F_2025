<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Club - HRA Function 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ==================== HEADER ==================== */
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* ==================== LOADING ==================== */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            min-height: 50vh;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: #999;
            font-size: 1rem;
        }

        /* ==================== REGISTRATION ==================== */
        .registration {
            display: none;
            max-width: 400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .reg-card {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid #333;
        }

        .reg-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .reg-header h2 {
            color: #ffffff;
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }

        .reg-header p {
            color: #999;
            font-size: 0.9rem;
        }

        .line-info {
            background: #333;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #00c300;
            text-align: center;
        }

        .line-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-bottom: 0.5rem;
        }

        .line-info h4 {
            color: #ffffff;
            margin-bottom: 0.25rem;
        }

        .line-info p {
            color: #999;
            font-size: 0.8rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ffffff;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #333;
            color: #ffffff;
            transition: border-color 0.3s ease;
            text-transform: uppercase;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .employee-info {
            display: none;
            background: #333;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid #27ae60;
        }

        .employee-info h4 {
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .employee-info p {
            margin: 0.25rem 0;
            color: #ccc;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: none;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #219a52;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background-color: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* ==================== CINEMA SEATING ==================== */
        .cinema-container {
            display: none;
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }

        .booking-info {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            text-align: center;
            color: #ffffff;
        }

        .booking-info h3 {
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .user-name {
            color: #4caf50;
            font-weight: 600;
        }

        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #2a2a2a;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #ccc;
        }

        .legend-seat {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            background-size: cover;
            background-position: center;
        }

        .legend-seat.available {
            background-image: url("https://drive.google.com/thumbnail?id=13EpT70QOGuThPHaCsbD44Q4cdMUpElfL&sz=w40");
        }

        .legend-seat.booked {
            background-image: url("https://raw.githubusercontent.com/HappyWorkPlace/HRA_F_2025/main/booked.png");
        }

        .legend-seat.selected {
            background-color: #ff9800;
        }

        .legend-seat.vip {
            background-image: url("https://drive.google.com/thumbnail?id=1TSU5WQqDC5lrWYN8SSq9agRVLfSsFHUu&sz=w40");
        }

        /* Screen */
        .screen-container {
            padding: 6px 12px 4px;
            position: relative;
            flex-shrink: 0;
            text-align: center;
            margin: 2rem 0 3rem 0;
        }

        .screen {
            width: 80%;
            max-width: 300px;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255,193,61,0.3) 20%, 
                rgba(255,193,61,0.8) 50%, 
                rgba(255,193,61,0.3) 80%, 
                transparent 100%
            );
            border-radius: 50%;
            margin: 0 auto 2px auto;
            box-shadow: 0 0 8px rgba(255,193,61,0.4);
        }

        .screen-label {
            text-align: center;
            font-size: 8px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.7;
        }

        /* Seating Map */
        .seating-map {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .seating-wrapper {
            max-width: 100%;
            overflow-x: auto;
            padding: 1rem 0;
        }

        .seat-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 3px;
        }

        .row-label {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            color: #ffffff;
            margin-right: 10px;
        }

        .seat {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
        }

        .seat.available:hover {
            transform: scale(1.1);
        }

        .seat.booked {
            background-image: url("https://raw.githubusercontent.com/HappyWorkPlace/HRA_F_2025/main/booked.png") !important;
            background-size: cover !important;
            background-position: center !important;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .seat.selected {
            transform: scale(1.1);
            background-size: cover !important;
            background-position: center !important;
            opacity: 0.7;
            background-image: url("https://raw.githubusercontent.com/HappyWorkPlace/HRA_F_2025/main/booking.png") !important;
        }

        .seat.regular {
            background-image: url("https://drive.google.com/thumbnail?id=13EpT70QOGuThPHaCsbD44Q4cdMUpElfL&sz=w80");
        }

        .seat.vip {
            background-image: url("https://drive.google.com/thumbnail?id=1TSU5WQqDC5lrWYN8SSq9agRVLfSsFHUu&sz=w80");
        }

        .aisle {
            width: 20px;
        }

        /* Booking Controls */
        .booking-controls {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            text-align: center;
        }

        .selected-info {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #333;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            color: #ffffff;
        }

        .selected-seats {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .selected-seat-tag {
            background: #3498db;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* ==================== ALREADY BOOKED ==================== */
        .already-booked {
            display: none;
            max-width: 400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .booked-card {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid #333;
            text-align: center;
        }

        .booked-header {
            margin-bottom: 2rem;
        }

        .booked-header h2 {
            color: #4caf50;
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }

        .booking-details {
            background: #333;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #4caf50;
        }

        .booking-details h4 {
            color: #ffffff;
            margin-bottom: 1rem;
        }

        .booking-details p {
            margin: 0.5rem 0;
            color: #ccc;
        }

        .booking-details .seat-display {
            background: #4caf50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1.1rem;
            font-weight: bold;
            display: inline-block;
            margin: 0.5rem 0;
        }

        /* ==================== ALERTS ==================== */
        .alert {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-success {
            background-color: rgba(39, 174, 96, 0.1);
            border-left-color: #27ae60;
            color: #27ae60;
        }

        .alert-error {
            background-color: rgba(231, 76, 60, 0.1);
            border-left-color: #e74c3c;
            color: #e74c3c;
        }

        .alert-warning {
            background-color: rgba(241, 196, 15, 0.1);
            border-left-color: #f1c40f;
            color: #f1c40f;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3rem;
            }
            
            .seat {
                width: 30px;
                height: 30px;
            }
            
            .row-label {
                min-width: 25px;
                font-size: 0.9rem;
            }

            .seat-legend {
                gap: 0.5rem;
            }

            .legend-item {
                font-size: 0.7rem;
            }
        }

        /* ==================== UTILITIES ==================== */
        .text-center {
            text-align: center;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>üé¨ Cinema Club</h1>
        <p>HRA Function 2025 - Register</p>
    </header>

    <!-- Loading Section -->
    <section id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...</p>
    </section>

    <!-- Registration Section -->
    <section id="registration" class="registration">
        <div class="reg-card">
            <div class="reg-header">
                <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÉ‡∏ô‡∏á‡∏≤‡∏ô</h2>
                <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
            </div>

            <!-- LINE Info -->
            <div id="lineInfo" class="line-info">
                <img id="lineAvatar" src="" alt="Avatar">
                <h4 id="lineDisplayName">-</h4>
            </div>
            
            <form id="registrationForm">
                <div class="form-group">
                    <label for="empNo">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="empNo" name="empNo" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required>
                </div>
                
                <button type="submit" class="btn btn-primary" id="checkBtn">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </form>
            
            <!-- Employee Info (Hidden initially) -->
            <div id="employeeInfo" class="employee-info">
                <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h4>
                <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="empName">-</span></p>
                <p><strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> <span id="empDept">-</span></p>
                <p><strong>‡∏£‡∏´‡∏±‡∏™:</strong> <span id="empCode">-</span></p>
                <button id="confirmReg" class="btn btn-success" style="margin-top: 1rem;">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</button>
            </div>

            <!-- Alert Messages -->
            <div id="alertMessages"></div>
        </div>
    </section>

    <!-- Cinema Seating Section -->
    <section id="cinema" class="cinema-container">
        <!-- User Info -->
        <div class="booking-info">
            <h3>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ <span class="user-name" id="userName">-</span></h3>
            <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ 1 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</p>
        </div>

        <!-- Seat Legend -->
        <div class="seat-legend">
            <div class="legend-item">
                <div class="legend-seat available"></div>
                <span>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ß‡πà‡∏≤‡∏á</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat vip"></div>
                <span>VIP</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat selected"></div>
                <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat booked"></div>
                <span>‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
            </div>
        </div>

        <!-- Screen -->
        <div class="screen-container">
            <div class="screen"></div>
            <div class="screen-label">‡∏à‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</div>
        </div>

        <!-- Seating Map -->
        <main class="seating-map">
            <div class="seating-wrapper" id="seatingWrapper">
                <!-- Seats will be generated here -->
            </div>
        </main>

        <!-- Booking Controls -->
        <div class="booking-controls">
            <div id="selectedInfo" class="selected-info" style="display:none;">
                <p><strong>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</strong></p>
                <div class="selected-seats" id="selectedSeats"></div>
            </div>
            <button id="confirmBooking" class="btn btn-success" style="display:none;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        </div>
    </section>

    <!-- Already Booked Section -->
    <section id="alreadyBooked" class="already-booked">
        <div class="booked-card">
            <div class="booked-header">
                <p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</p>
            </div>
            
            <div class="booking-details">
                <h4>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h4>
                <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="bookedName">-</span></p>
                <p><strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> <span id="bookedDept">-</span></p>
                <p><strong>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á:</strong></p>
                <div class="seat-display" id="bookedSeat">-</div>
                <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á:</strong> <span id="bookedTime">-</span></p>
            </div>
        </div>
    </section>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Main Script -->
    <script>
        // ==================== CONFIGURATION ====================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzDFe-UmxrioicKjQRQmha9XLmkBZlcpmRS2PstuwiynZmyWXlNOdpXGKYUSr2-UqOE/exec';
        const LIFF_ID = '2008529302-50MNLyDV';

        // ==================== GLOBAL VARIABLES ====================
        let lineProfile = null;
        let currentEmployee = null;
        let selectedSeats = [];
        let allBookings = [];

        // Seat Layout (170 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á)
        const seatLayout = {
            'A': { count: 14, type: 'regular', split: 7 },
            'B': { count: 14, type: 'regular', split: 7 },
            'C': { count: 14, type: 'regular', split: 7 },
            'D': { count: 14, type: 'regular', split: 7 },
            'E': { count: 14, type: 'regular', split: 7 },
            'F': { count: 14, type: 'regular', split: 7 },
            'G': { count: 14, type: 'regular', split: 7 },
            'H': { count: 14, type: 'regular', split: 7 },
            'I': { count: 12, type: 'regular', split: 6 },
            'J': { count: 12, type: 'regular', split: 6 },
            'K': { count: 10, type: 'regular', split: 5 },
            'V1': { count: 8, type: 'vip', split: 4 },
            'V2': { count: 8, type: 'vip', split: 4 },
            'V3': { count: 8, type: 'vip', split: 4 }
        };

        // ==================== JSONP HELPER ====================
        function makeJSONPRequest(url, params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                // Create callback function
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                // Create script element
                const script = document.createElement('script');
                
                // Build URL with parameters
                const urlParams = new URLSearchParams(params);
                urlParams.append('callback', callbackName);
                
                script.src = `${url}?${urlParams.toString()}`;
                
                // Handle errors
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                
                // Add script to document
                document.body.appendChild(script);
            });
        }

        // ==================== API CALLS (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô JSONP) ====================
        async function apiCall(action, params = {}) {
            try {
                const allParams = { action, ...params };
                const result = await makeJSONPRequest(API_URL, allParams);
                return result;
            } catch (error) {
                console.error('API call error:', error);
                return { success: false, message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ' };
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            initializeLIFF();
        });

        async function initializeLIFF() {
            try {
                updateLoadingText('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° LINE LIFF...');
                
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    updateLoadingText('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE...');
                    liff.login();
                    return;
                }

                updateLoadingText('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...');
                lineProfile = await liff.getProfile();
                
                displayLineInfo();
                await checkUserRegistration();
                
            } catch (error) {
                console.error('LIFF initialization error:', error);
                showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ: ' + error.message);
                showRegistrationForm();
            }
        }

        function updateLoadingText(text) {
            const loadingText = document.getElementById('loadingText');
            if (loadingText) loadingText.textContent = text;
        }

        function displayLineInfo() {
            if (lineProfile) {
                document.getElementById('lineAvatar').src = lineProfile.pictureUrl || '';
                document.getElementById('lineDisplayName').textContent = lineProfile.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
            }
        }

        async function checkUserRegistration() {
            try {
                updateLoadingText('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...');
                
                const result = await apiCall('getMyBookingByUID', {
                    lineUserId: lineProfile.userId
                });
                
                if (result.success && result.data && result.data.empNo) {
                    // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
                    displayBookingResult(result.data);
                } else {
                    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    showRegistrationForm();
                }
            } catch (error) {
                console.error('Error checking registration:', error);
                showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                showRegistrationForm();
            }
        }

        function showRegistrationForm() {
            hideLoading();
            document.getElementById('registration').style.display = 'block';
            setupRegistrationForm();
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // ==================== REGISTRATION ====================
        function setupRegistrationForm() {
            const form = document.getElementById('registrationForm');
            const empNoInput = document.getElementById('empNo');
            
            // Force uppercase
            empNoInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
            
            form.addEventListener('submit', handleEmployeeCheck);
        }

        async function handleEmployeeCheck(e) {
            e.preventDefault();
            
            const empNo = document.getElementById('empNo').value.trim();
            if (!empNo) {
                showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                return;
            }

            const checkBtn = document.getElementById('checkBtn');
            checkBtn.disabled = true;
            checkBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

            try {
                const result = await apiCall('getEmployeeInfo', { empNo: empNo });
                
                if (result.success) {
                    currentEmployee = { empNo: empNo, ...result.data };
                    showEmployeeInfo(result.data);
                } else {
                    showAlert('error', result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                }
            } catch (error) {
                console.error('Error checking employee:', error);
                showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
            } finally {
                checkBtn.disabled = false;
                checkBtn.textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        }

        function showEmployeeInfo(employee) {
            document.getElementById('empName').textContent = employee.name || '-';
            document.getElementById('empDept').textContent = employee.factory || '-';
            document.getElementById('empCode').textContent = currentEmployee.empNo || '-';
            
            document.getElementById('employeeInfo').style.display = 'block';
            document.getElementById('confirmReg').addEventListener('click', proceedToBooking);
            
            clearAlerts();
        }

        async function proceedToBooking() {
            try {
                updateLoadingText('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á...');
                showLoading();
                
                await loadBookingData();
                showCinemaSection();
                
            } catch (error) {
                console.error('Error proceeding to booking:', error);
                showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ');
                hideLoading();
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('registration').style.display = 'none';
        }

        async function loadBookingData() {
            const result = await apiCall('getAllBookings');
            
            if (result.success) {
                allBookings = result.data || [];
            } else {
                allBookings = [];
                console.warn('Could not load booking data:', result.message);
            }
        }

        function showCinemaSection() {
            hideLoading();
            document.getElementById('registration').style.display = 'none';
            document.getElementById('cinema').style.display = 'block';
            
            // Display user info
            document.getElementById('userName').textContent = currentEmployee.name || currentEmployee.empNo;
            
            // Generate seating map
            generateSeatingMap();
        }

        // ==================== SEATING ====================
        function generateSeatingMap() {
            const seatingWrapper = document.getElementById('seatingWrapper');
            seatingWrapper.innerHTML = '';

            // Get list of booked seats
            const bookedSeatIds = allBookings.map(booking => booking.seatId);

            for (const [rowLabel, rowData] of Object.entries(seatLayout)) {
                const seatRow = document.createElement('div');
                seatRow.className = 'seat-row';

                // Row Label
                const rowLabelDiv = document.createElement('div');
                rowLabelDiv.className = 'row-label';
                rowLabelDiv.textContent = rowLabel;
                seatRow.appendChild(rowLabelDiv);

                // First half of seats
                for (let i = 1; i <= rowData.split; i++) {
                    const seat = createSeat(rowLabel, i, rowData.type, bookedSeatIds);
                    seatRow.appendChild(seat);
                }

                // Aisle
                const aisle = document.createElement('div');
                aisle.className = 'aisle';
                seatRow.appendChild(aisle);

                // Second half of seats
                for (let i = rowData.split + 1; i <= rowData.count; i++) {
                    const seat = createSeat(rowLabel, i, rowData.type, bookedSeatIds);
                    seatRow.appendChild(seat);
                }

                seatingWrapper.appendChild(seatRow);
            }

            setupBookingControls();
        }

        function createSeat(row, number, type, bookedSeatIds) {
            const seat = document.createElement('div');
            const seatId = `${row}${number}`;
            
            seat.className = `seat ${type}`;
            seat.setAttribute('data-seat', seatId);
            seat.setAttribute('data-row', row);
            seat.setAttribute('data-number', number);
            seat.setAttribute('data-type', type);
            
            if (bookedSeatIds.includes(seatId)) {
                seat.classList.add('booked');
            } else {
                seat.classList.add('available');
                seat.addEventListener('click', selectSeat);
            }

            return seat;
        }

        function selectSeat() {
            if (this.classList.contains('booked')) return;

            const seatId = this.getAttribute('data-seat');
            
            if (this.classList.contains('selected')) {
                // Deselect
                this.classList.remove('selected');
                this.classList.add('available');
                selectedSeats = selectedSeats.filter(seat => seat !== seatId);
            } else {
                // Select (limit to 1 seat)
                if (selectedSeats.length >= 1) {
                    showAlert('warning', '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    return;
                }
                
                this.classList.remove('available');
                this.classList.add('selected');
                selectedSeats.push(seatId);
            }

            updateSelectedInfo();
        }

        function updateSelectedInfo() {
            const selectedInfo = document.getElementById('selectedInfo');
            const selectedSeatsDiv = document.getElementById('selectedSeats');
            const confirmBtn = document.getElementById('confirmBooking');

            if (selectedSeats.length > 0) {
                selectedInfo.style.display = 'block';
                confirmBtn.style.display = 'block';
                
                selectedSeatsDiv.innerHTML = '';
                selectedSeats.forEach(seatId => {
                    const seatTag = document.createElement('div');
                    seatTag.className = 'selected-seat-tag';
                    seatTag.textContent = seatId;
                    selectedSeatsDiv.appendChild(seatTag);
                });
            } else {
                selectedInfo.style.display = 'none';
                confirmBtn.style.display = 'none';
            }
        }

        function setupBookingControls() {
            document.getElementById('confirmBooking').addEventListener('click', handleBookingConfirmation);
        }

        async function handleBookingConfirmation() {
            if (selectedSeats.length === 0) return;
            
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ${selectedSeats.join(', ')} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                return;
            }

            const confirmBtn = document.getElementById('confirmBooking');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á...';

            try {
                const result = await apiCall('bookSeat', {
                    empNo: currentEmployee.empNo,
                    name: encodeURIComponent(currentEmployee.name || ''),
                    factory: encodeURIComponent(currentEmployee.factory || ''),
                    seatId: selectedSeats[0],
                    lineUserId: lineProfile.userId
                });
                
                if (result.success) {
                    showAlert('success', 'üéâ ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    
                    // Update UI
                    selectedSeats.forEach(seatId => {
                        const seatElement = document.querySelector(`[data-seat="${seatId}"]`);
                        if (seatElement) {
                            seatElement.classList.remove('selected', 'available');
                            seatElement.classList.add('booked');
                            seatElement.removeEventListener('click', selectSeat);
                        }
                    });
                    
                    // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πã‡∏ß‡∏ú‡πà‡∏≤‡∏ô LIFF ‡πÉ‡∏´‡∏°‡πà
                    setTimeout(() => {
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πã‡∏ß
                        const ticketData = {
                            empNo: currentEmployee.empNo,
                            name: currentEmployee.name,
                            factory: currentEmployee.factory,
                            seatId: selectedSeats[0],
                            bookingTime: new Date().toLocaleString('th-TH'),
                            lineUserId: lineProfile.userId
                        };
                        
                        localStorage.setItem('cinemaTicketData', JSON.stringify(ticketData));
                        
                        console.log('Redirecting to LIFF ticket with data:', ticketData);
                        
                        // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πã‡∏ß‡∏ú‡πà‡∏≤‡∏ô LIFF ID ‡πÉ‡∏´‡∏°‡πà
                        window.location.href = 'https://liff.line.me/2008529302-VgK0MJqm';
                    }, 2000);
                    
                } else {
                    showAlert('error', result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ');
                }
                
            } catch (error) {
                console.error('Error booking seat:', error);
                showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ' + error.message);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
                selectedSeats = [];
                updateSelectedInfo();
            }
        }

        // ==================== ALREADY BOOKED ====================
        function displayBookingResult(booking) {
            // Hide all other sections
            document.getElementById('loading').style.display = 'none';
            document.getElementById('registration').style.display = 'none';
            document.getElementById('cinema').style.display = 'none';
            
            // Show booking result
            document.getElementById('alreadyBooked').style.display = 'block';
            
            // Fill booking details
            document.getElementById('bookedName').textContent = booking.name || '-';
            document.getElementById('bookedDept').textContent = booking.factory || '-';
            document.getElementById('bookedSeat').textContent = booking.seatId || '-';
            document.getElementById('bookedTime').textContent = booking.bookingTime || '-';
        }

        // ==================== UTILITIES ====================
        function showAlert(type, message) {
            const alertMessages = document.getElementById('alertMessages');
            if (!alertMessages) return;

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            alertMessages.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function clearAlerts() {
            const alertMessages = document.getElementById('alertMessages');
            if (alertMessages) {
                alertMessages.innerHTML = '';
            }
        }
    </script>
</body>
</html>
