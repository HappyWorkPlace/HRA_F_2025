<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>HRA Cinema Club - Booking</title>
<style>
  :root {
    --bg:#0a0c10; 
    --panel:#12151c; 
    --line:#1f2530; 
    --text:#f0f2f5; 
    --muted:#8892a0;
    --accent:#ff6b6b;
    --success:#4caf50;
    --primary:#00C300; /* LINE Green */
  }
  
  * { 
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: linear-gradient(135deg, #0a0c10 0%, #1a1d26 100%);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  
  .container {
    width: 100%;
    max-width: 400px;
    background: var(--panel);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  
  .logo {
    text-align: center;
    margin-bottom: 1.5rem;
  }
  
  .title {
    font-size: 1.4rem;
    font-weight: 700;
    background: linear-gradient(135deg, #ff6b6b, #ffc93d);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: center;
    margin-bottom: 0.25rem;
  }
  
  .subtitle {
    text-align: center;
    color: var(--muted);
    font-size: 0.85rem;
    margin-bottom: 1.5rem;
  }
  
  .info-card {
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 1rem;
  }
  
  .info-item {
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
  }
  
  .info-item:last-child {
    margin-bottom: 0;
  }
  
  .info-label {
    font-size: 0.8rem;
    color: var(--muted);
    margin-bottom: 0.1rem;
  }
  
  .info-value {
    font-size: 0.95rem;
    color: var(--text);
    font-weight: 600;
  }
  
  .seat-section-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .seat-legend {
    display:flex;
    flex-wrap:wrap;
    gap:0.5rem;
    margin-bottom:0.75rem;
    font-size:0.75rem;
  }
  .seat-legend-item {
    display:flex;
    align-items:center;
    gap:0.3rem;
    color: var(--muted);
  }
  .seat-dot {
    width:12px;
    height:12px;
    border-radius:4px;
    border:1px solid var(--line);
  }
  .dot-regular { background: rgba(255,255,255,0.08); }
  .dot-sweet   { background: rgba(255,107,107,0.18); }
  .dot-vip     { background: rgba(255,201,61,0.2); }
  .dot-mine    { border-color: var(--primary); }

  .seat-grid-wrapper{
    max-height:220px;
    overflow-y:auto;
    margin-bottom:0.75rem;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.03);
    padding:0.5rem;
    background:rgba(0,0,0,0.15);
  }

  .seat-row {
    display:flex;
    align-items:center;
    margin-bottom:0.35rem;
  }
  .row-label {
    width:22px;
    text-align:center;
    font-size:0.75rem;
    color:var(--muted);
    margin-right:0.25rem;
  }
  .seat-row-buttons {
    display:flex;
    gap:0.25rem;
    flex-wrap:wrap;
  }

  .seat-btn {
    min-width:30px;
    height:26px;
    border-radius:8px;
    border:1px solid var(--line);
    background:rgba(255,255,255,0.04);
    font-size:0.75rem;
    color:var(--text);
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all 0.15s;
  }
  .seat-btn.regular { }
  .seat-btn.sweet   { background:rgba(255,107,107,0.18); }
  .seat-btn.vip     { background:rgba(255,201,61,0.2); }
  .seat-btn:hover:not(.disabled) {
    transform:translateY(-1px);
    box-shadow:0 4px 10px rgba(0,0,0,0.35);
  }
  .seat-btn.selected {
    border-color: var(--primary);
    box-shadow:0 0 0 1px rgba(0,195,0,0.7);
  }
  .seat-btn.mine {
    border-color: var(--primary);
    box-shadow:0 0 0 1px rgba(0,195,0,1);
  }
  .seat-btn.disabled {
    opacity:0.4;
    cursor:not-allowed;
  }
  .seat-btn.disabled::after {
    content:'X';
    font-size:0.7rem;
    color:#ff8a80;
    margin-left:2px;
  }

  .selection-summary {
    font-size:0.8rem;
    color:var(--muted);
    margin-bottom:0.5rem;
  }
  .selection-summary span {
    color:var(--text);
    font-weight:600;
  }

  .btn {
    width: 100%;
    padding: 0.85rem;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 0.75rem;
  }
  
  .btn:last-child {
    margin-bottom: 0;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,195,0,0.4);
  }
  
  .btn-secondary {
    background: rgba(255,255,255,0.1);
    color: var(--text);
    border: 1px solid var(--line);
  }
  
  .btn-secondary:hover:not(:disabled) {
    background: rgba(255,255,255,0.15);
  }
  
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-row {
    display:flex;
    gap:0.5rem;
  }

  .error-message {
    background: rgba(244,67,54,0.1);
    border: 1px solid rgba(244,67,54,0.3);
    color: #f44336;
    padding: 0.75rem;
    border-radius: 8px;
    margin-top: 0.5rem;
    margin-bottom: 0.25rem;
    display: none;
    font-size:0.8rem;
  }
  
  .success-message {
    background: rgba(76,175,80,0.1);
    border: 1px solid rgba(76,175,80,0.3);
    color: #4caf50;
    padding: 0.75rem;
    border-radius: 8px;
    margin-top: 0.5rem;
    margin-bottom: 0.25rem;
    display: none;
    font-size:0.8rem;
  }

  .stats {
    font-size:0.75rem;
    color:var(--muted);
    margin-top:0.4rem;
  }
</style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <div class="title">HRA CINEMA CLUB</div>
      <div class="subtitle">เลือกที่นั่งสำหรับการชมภาพยนตร์</div>
    </div>

    <!-- User Info -->
    <div class="info-card">
      <div class="info-item">
        <div class="info-label">รหัสพนักงาน</div>
        <div class="info-value" id="empNoText">-</div>
      </div>
      <div class="info-item">
        <div class="info-label">ชื่อ-สกุล</div>
        <div class="info-value" id="nameText">-</div>
      </div>
      <div class="info-item">
        <div class="info-label">โรงงาน</div>
        <div class="info-value" id="factoryText">-</div>
      </div>
    </div>

    <!-- Seat Section -->
    <div class="info-card">
      <div class="seat-section-title">เลือกที่นั่ง</div>

      <div class="seat-legend">
        <div class="seat-legend-item">
          <div class="seat-dot dot-regular"></div><span>Regular</span>
        </div>
        <div class="seat-legend-item">
          <div class="seat-dot dot-sweet"></div><span>Sweet (โซนคู่รัก)</span>
        </div>
        <div class="seat-legend-item">
          <div class="seat-dot dot-vip"></div><span>VIP Lounge</span>
        </div>
        <div class="seat-legend-item">
          <div class="seat-dot dot-mine"></div><span>ที่นั่งของฉัน</span>
        </div>
      </div>

      <div class="seat-grid-wrapper">
        <div id="seatGrid"></div>
      </div>

      <div class="selection-summary">
        เลือกที่นั่ง: <span id="selectedSeatText">-</span><br>
        ที่นั่งของฉันตอนนี้: <span id="mySeatText">-</span>
      </div>

      <div class="btn-row">
        <button class="btn btn-primary" id="bookBtn" disabled>ยืนยันการจอง</button>
        <button class="btn btn-secondary" id="refreshBtn">รีเฟรช</button>
      </div>
      <div class="btn-row">
        <button class="btn btn-secondary" id="cancelBtn">ยกเลิกที่นั่งของฉัน</button>
        <button class="btn btn-secondary" onclick="window.location.href='index.html'">กลับหน้าลงทะเบียน</button>
      </div>

      <div class="error-message" id="errorBox"></div>
      <div class="success-message" id="successBox"></div>
      <div class="stats" id="statsBox">
        จองแล้วทั้งหมด: <span id="statTotal">0</span> | Regular: <span id="statRegular">0</span> • Sweet: <span id="statSweet">0</span> • VIP: <span id="statVip">0</span>
      </div>
    </div>
  </div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbzDFe-UmxrioicKjQRQmha9XLmkBZlcpmRS2PstuwiynZmyWXlNOdpXGKYUSr2-UqOE/exec';

  let currentUser = null;
  let bookings = [];
  let myBooking = null;
  let selectedSeatId = null;

  // Layout: A–H = Regular, S = Sweet, L = VIP
  const seatLayout = [
    { row: 'A', seats: ['A1','A2','A3','A4',null,'A5','A6','A7','A8'] },
    { row: 'B', seats: ['B1','B2','B3','B4',null,'B5','B6','B7','B8'] },
    { row: 'C', seats: ['C1','C2','C3','C4',null,'C5','C6','C7','C8'] },
    { row: 'D', seats: ['D1','D2','D3','D4',null,'D5','D6','D7','D8'] },
    { row: 'E', seats: ['E1','E2','E3','E4',null,'E5','E6','E7','E8'] },
    { row: 'F', seats: ['F1','F2','F3','F4',null,'F5','F6','F7','F8'] },
    { row: 'G', seats: ['G1','G2','G3','G4',null,'G5','G6','G7','G8'] },
    { row: 'H', seats: ['H1','H2','H3','H4',null,'H5','H6','H7','H8'] },
    { row: 'S', seats: ['S1','S2',null,'S3','S4'] },
    { row: 'L', seats: ['L1','L2',null,'L3','L4'] }
  ];

  function apiCall(action, params = {}) {
    const url = new URL(API_URL);
    url.searchParams.append('action', action);
    Object.entries(params).forEach(([k,v])=>{
      if (v !== undefined && v !== null && v !== '') url.searchParams.append(k,v);
    });
    return fetch(url.toString()).then(r=>r.json());
  }

  function showError(msg){
    const box = document.getElementById('errorBox');
    box.textContent = msg;
    box.style.display = 'block';
    document.getElementById('successBox').style.display = 'none';
  }

  function showSuccess(msg){
    const box = document.getElementById('successBox');
    box.textContent = msg;
    box.style.display = 'block';
    document.getElementById('errorBox').style.display = 'none';
  }

  function clearMessages(){
    document.getElementById('errorBox').style.display = 'none';
    document.getElementById('successBox').style.display = 'none';
  }

  function buildSeats(){
    const grid = document.getElementById('seatGrid');
    grid.innerHTML = '';

    const bookedMap = {};
    bookings.forEach(b=>{
      if (b.seatId) bookedMap[b.seatId] = b;
    });

    const mySeatId = myBooking ? myBooking.seatId : null;

    seatLayout.forEach(row=>{
      const rowDiv = document.createElement('div');
      rowDiv.className = 'seat-row';

      const label = document.createElement('div');
      label.className = 'row-label';
      label.textContent = row.row;
      rowDiv.appendChild(label);

      const btnWrap = document.createElement('div');
      btnWrap.className = 'seat-row-buttons';

      row.seats.forEach(seatId=>{
        if (seatId === null) {
          const spacer = document.createElement('div');
          spacer.style.width = '12px';
          spacer.style.height = '1px';
          btnWrap.appendChild(spacer);
          return;
        }

        const btn = document.createElement('button');
        btn.className = 'seat-btn';

        if (seatId.startsWith('L')) btn.classList.add('vip');
        else if (seatId.startsWith('S')) btn.classList.add('sweet');
        else btn.classList.add('regular');

        btn.dataset.seatId = seatId;
        btn.textContent = seatId.replace(/^[A-Z]+/, '');

        const isBooked = !!bookedMap[seatId];
        const isMine   = mySeatId === seatId;

        if (isMine) {
          btn.classList.add('mine');
        }
        if (isBooked && !isMine) {
          btn.classList.add('disabled');
        }

        btn.addEventListener('click', ()=>onSeatClick(btn));
        btnWrap.appendChild(btn);
      });

      rowDiv.appendChild(btnWrap);
      grid.appendChild(rowDiv);
    });

    updateSelectionTexts();
  }

  function onSeatClick(btn){
    const seatId = btn.dataset.seatId;

    if (btn.classList.contains('disabled')) {
      showError('ที่นั่งนี้มีผู้จองแล้ว');
      return;
    }

    if (myBooking && myBooking.seatId && myBooking.seatId !== seatId) {
      showError('คุณได้จองที่นั่ง ' + myBooking.seatId + ' แล้ว หากต้องการเปลี่ยน กรุณายกเลิกที่นั่งเดิมก่อน');
      return;
    }

    clearMessages();

    if (selectedSeatId === seatId){
      selectedSeatId = null;
    }else{
      selectedSeatId = seatId;
    }

    document.querySelectorAll('.seat-btn').forEach(s=>s.classList.remove('selected'));
    if (selectedSeatId){
      const el = document.querySelector(`.seat-btn[data-seat-id="${selectedSeatId}"]`);
      if (el) el.classList.add('selected');
    }

    updateSelectionTexts();
  }

  function updateSelectionTexts(){
    document.getElementById('selectedSeatText').textContent = selectedSeatId || '-';
    document.getElementById('mySeatText').textContent       = myBooking && myBooking.seatId ? myBooking.seatId : '-';
    document.getElementById('bookBtn').disabled             = !selectedSeatId || (myBooking && myBooking.seatId === selectedSeatId);
  }

  async function refreshAll(){
    if (!currentUser) return;
    clearMessages();
    document.getElementById('refreshBtn').disabled = true;

    try{
      const [all, mine, stats] = await Promise.all([
        apiCall('getAllBookings'),
        apiCall('getMyBooking', { empNo: currentUser.empNo }),
        apiCall('getBookingStats')
      ]);

      bookings   = Array.isArray(all) ? all : [];
      myBooking  = mine && mine.seatId ? mine : null;
      selectedSeatId = myBooking ? myBooking.seatId : null;

      buildSeats();

      if (stats){
        document.getElementById('statTotal').textContent   = stats.total   || 0;
        document.getElementById('statRegular').textContent = stats.regular || 0;
        document.getElementById('statSweet').textContent   = stats.sweet   || 0;
        document.getElementById('statVip').textContent     = stats.vip     || 0;
      }
    }catch(err){
      console.error(err);
      showError('โหลดข้อมูลไม่สำเร็จ');
    }finally{
      document.getElementById('refreshBtn').disabled = false;
    }
  }

  async function bookSelected(){
    if (!currentUser || !selectedSeatId) return;
    clearMessages();

    const btn = document.getElementById('bookBtn');
    btn.disabled = true;
    btn.textContent = 'กำลังจอง...';

    try{
      const res = await apiCall('bookSeat', {
        empNo: currentUser.empNo,
        name: currentUser.name,
        factory: currentUser.factory,
        seatId: selectedSeatId
      });

      if (res && res.success){
        showSuccess(res.message || 'จองที่นั่งสำเร็จ');
      }else{
        showError(res && res.message ? res.message : 'ไม่สามารถจองที่นั่งได้');
      }

      await refreshAll();
    }catch(err){
      console.error(err);
      showError('เกิดข้อผิดพลาดในการจอง');
    }finally{
      btn.textContent = 'ยืนยันการจอง';
      btn.disabled    = !selectedSeatId;
    }
  }

  async function cancelMySeat(){
    if (!currentUser) return;

    if (!myBooking || !myBooking.seatId){
      showError('คุณยังไม่มีการจองที่นั่ง');
      return;
    }

    const ok = confirm('ต้องการยกเลิกที่นั่ง ' + myBooking.seatId + ' ใช่หรือไม่?');
    if (!ok) return;

    clearMessages();

    const btn = document.getElementById('cancelBtn');
    btn.disabled = true;
    btn.textContent = 'กำลังยกเลิก...';

    try{
      const res = await apiCall('cancelBooking', { empNo: currentUser.empNo });
      if (res && res.success){
        showSuccess(res.message || 'ยกเลิกการจองสำเร็จ');
      }else{
        showError(res && res.message ? res.message : 'ไม่สามารถยกเลิกการจองได้');
      }
      selectedSeatId = null;
      await refreshAll();
    }catch(err){
      console.error(err);
      showError('เกิดข้อผิดพลาดในการยกเลิก');
    }finally{
      btn.disabled = false;
      btn.textContent = 'ยกเลิกที่นั่งของฉัน';
    }
  }

  function initUser(){
    const raw = sessionStorage.getItem('userData');
    if (!raw){
      alert('ไม่พบข้อมูลผู้ใช้ กรุณากลับไปหน้าลงทะเบียน');
      window.location.href = 'index.html';
      return false;
    }
    try{
      const data = JSON.parse(raw);
      if (!data.empNo) throw new Error('no empNo');
      currentUser = data;
      document.getElementById('empNoText').textContent = data.empNo;
      document.getElementById('nameText').textContent  = data.name;
      document.getElementById('factoryText').textContent = data.factory || '-';
      return true;
    }catch(e){
      console.error(e);
      alert('ข้อมูลผู้ใช้ไม่ถูกต้อง กรุณากลับไปหน้าลงทะเบียน');
      window.location.href = 'index.html';
      return false;
    }
  }

  document.getElementById('bookBtn').addEventListener('click', bookSelected);
  document.getElementById('refreshBtn').addEventListener('click', refreshAll);
  document.getElementById('cancelBtn').addEventListener('click', cancelMySeat);

  (function(){
    if (!initUser()) return;
    refreshAll();
  })();
</script>
</body>
</html>
