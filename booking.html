<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>HRA Cinema Club - Seat Selection</title>
<style>
  /* ============ MOBILE-FIRST CONFIGURATION ============ */
  :root{
    /* Seat images from Google Drive */
    --img-regular: url("https://drive.google.com/thumbnail?id=13EpT70QOGuThPHaCsbD44Q4cdMUpElfL&sz=w80");
    --img-vip:     url("https://drive.google.com/thumbnail?id=1TSU5WQqDC5lrWYN8SSq9agRVLfSsFHUu&sz=w80");
    --img-sweet: url("https://drive.google.com/thumbnail?id=1Du01KILJxPZZQf0vZnABSilXcMfqNX32&sz=w80");

    /* Person icon for booked seats */
    --img-person: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>\
  <circle cx='32' cy='20' r='8' fill='none' stroke='%23fff' stroke-width='3'/>\
  <path d='M18 52c0-7.73 6.27-14 14-14s14 6.27 14 14' fill='none' stroke='%23fff' stroke-width='3' stroke-linecap='round'/>\
</svg>");

    /* Clean minimal colors - matching index.html */
    --bg: #0f1419; 
    --panel: #1a1f2e; 
    --line: #2d3748; 
    --text: #e2e8f0; 
    --muted: #94a3b8;
    --accent: #3b82f6;
    --vip: #f59e0b;
    --sweet: #ec4899;
    --success: #10b981;
    --primary: #00C851; /* LINE Green */
    --white: #ffffff;
  }

  * { 
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  html, body {
    height: 100%;
    overflow: hidden;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, var(--bg) 0%, #1e293b 100%);
    color: var(--text);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .container {
    width: 100%;
    height: 100%;
    max-width: 100vw;
    max-height: 100vh;
    background: var(--panel);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ===== COMPACT USER HEADER ===== */
  .user-header {
    background: linear-gradient(135deg, #1f2530 0%, var(--panel) 100%);
    padding: 8px 12px;
    border-bottom: 1px solid var(--line);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  
  .user-info {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 0;
  }
  
  .user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid var(--primary);
    object-fit: cover;
    flex-shrink: 0;
  }
  
  .user-details {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }
  
  .user-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .user-badge {
    font-size: 10px;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .user-badge span {
    color: var(--primary);
    font-weight: 600;
  }
  
  .refresh-btn {
    background: rgba(255,255,255,0.08);
    border: 1px solid var(--line);
    color: var(--text);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 10px;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  
  .refresh-btn:hover {
    background: rgba(255,255,255,0.12);
  }

  /* ===== COMPACT EVENT HEADER ===== */
  .event-header {
    background: linear-gradient(135deg, #1f2530 0%, var(--panel) 100%);
    padding: 6px 12px;
    text-align: center;
    border-bottom: 1px solid var(--line);
    flex-shrink: 0;
  }
  
  .event-title {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.1em;
    color: var(--vip);
    text-transform: uppercase;
    margin-bottom: 2px;
    opacity: 0.9;
  }
  
  .event-name {
    font-size: 14px;
    font-weight: 700;
    background: linear-gradient(135deg, #ff6b6b, #ffc93d);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* ===== COMPACT SCREEN ===== */
  .screen-container {
    padding: 6px 12px 4px;
    position: relative;
    flex-shrink: 0;
  }
  
  .screen {
    height: 2px;
    background: linear-gradient(90deg, 
      transparent 0%, 
      rgba(255,193,61,0.3) 20%, 
      rgba(255,193,61,0.8) 50%, 
      rgba(255,193,61,0.3) 80%, 
      transparent 100%
    );
    border-radius: 50%;
    margin-bottom: 2px;
    box-shadow: 0 0 8px rgba(255,193,61,0.4);
  }
  
  .screen-label {
    text-align: center;
    font-size: 8px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.7;
  }

  /* ===== SEATING MAP (MOBILE OPTIMIZED) ===== */
  .seating-map {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px 8px;
    overflow: auto;
  }
  
  .seating-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
  }
  
  .row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1px;
    margin-bottom: 2px;
    position: relative;
    width: 100%;
  }
  
  .section-divider {
    height: 6px;
    width: 100%;
    position: relative;
  }
  
  .section-divider::before {
    content: "";
    position: absolute;
    left: 20%;
    right: 20%;
    top: 50%;
    height: 1px;
    background: linear-gradient(90deg, 
      transparent, 
      var(--line) 20%, 
      var(--line) 80%, 
      transparent
    );
    opacity: 0.3;
  }
  
  .row-label {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 9px;
    color: var(--muted);
    background: rgba(255,255,255,0.05);
    border-radius: 3px;
    margin: 0 2px;
    flex-shrink: 0;
  }
  
  .row-label.vvip {
    color: var(--vip);
    background: rgba(255,193,61,0.1);
  }
  
  .row-label.sweet {
    color: var(--sweet);
    background: rgba(255,105,180,0.1);
  }
  
  .seat-block {
    display: flex;
    gap: 1px;
  }
  
  .center-aisle {
    width: 8px;
  }
  
  .seat {
    position: relative;
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }
  
  .seat-inner {
    display: block;
    width: 100%;
    height: 100%;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    border-radius: 3px;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .seat.regular .seat-inner {
    background-image: var(--img-regular);
  }
  
  .seat.vip .seat-inner {
    background-image: var(--img-vip);
  }
  
  .seat.sweet .seat-inner {
    background-image: var(--img-sweet);
  }
  
  /* Available seats - can be clicked */
  .seat.available {
    cursor: pointer;
  }
  
  .seat.available:hover .seat-inner {
    transform: scale(1.2);
    filter: brightness(1.3);
    z-index: 10;
  }
  
  .seat.available:active .seat-inner {
    transform: scale(0.9);
  }
  
  /* Booked seats - clickable for view */
  .seat.booked {
    cursor: pointer;
  }
  
  .seat.booked .seat-inner {
    opacity: 0.6;
  }
  
  .seat.booked .seat-inner::after {
    content: "";
    position: absolute;
    inset: 0;
    background: var(--img-person) center/65% no-repeat;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.8));
  }
  
  .seat.booked:hover .seat-inner {
    opacity: 0.8;
    transform: scale(1.1);
  }
  
  /* My seat - special highlighting */
  .seat.mine .seat-inner {
    opacity: 1;
    box-shadow: 0 0 0 1px var(--primary), 0 0 6px rgba(0,195,0,0.6);
    animation: pulse 2s infinite;
  }
  
  .seat.mine .seat-inner::after {
    content: "";
    position: absolute;
    inset: 0;
    background: var(--img-person) center/65% no-repeat;
    filter: drop-shadow(0 1px 2px rgba(0,195,0,0.8));
  }
  
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 1px var(--primary), 0 0 6px rgba(0,195,0,0.6); }
    50% { box-shadow: 0 0 0 1px var(--primary), 0 0 10px rgba(0,195,0,0.8); }
  }
  
  /* Unavailable seats - no interaction */
  .seat:not(.available):not(.booked):not(.mine) {
    cursor: default;
  }
  
  .seat:not(.available):not(.booked):not(.mine) .seat-inner {
    opacity: 0.3;
  }

  /* ===== MOBILE MODAL ===== */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 1000;
    align-items: flex-end;
    justify-content: center;
    animation: fadeIn 0.3s;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .modal.active {
    display: flex;
  }
  
  .modal-content {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 20px 20px 0 0;
    padding: 20px;
    width: 100%;
    max-width: 100vw;
    max-height: 80vh;
    overflow-y: auto;
    animation: slideUp 0.4s ease-out;
  }
  
  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .modal-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--vip);
  }
  
  .modal-close {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  
  .modal-close:hover {
    color: var(--text);
  }
  
  .seat-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px 0;
  }
  
  .seat-preview-icon {
    font-size: 48px;
  }
  
  .seat-preview-id {
    font-size: 32px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--vip));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-left: 16px;
  }
  
  .info-item {
    padding: 12px 16px;
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    margin-bottom: 8px;
  }
  
  .info-item:last-of-type {
    margin-bottom: 0;
  }
  
  .info-label {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }
  
  .info-value {
    font-size: 14px;
    color: var(--text);
    font-weight: 600;
  }
  
  .modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }
  
  .modal-actions .btn {
    flex: 1;
  }
  
  .btn {
    padding: 14px 20px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--vip));
    color: white;
    box-shadow: 0 4px 12px rgba(255,107,107,0.3);
  }
  
  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255,107,107,0.4);
  }
  
  .btn-secondary {
    background: rgba(255,255,255,0.08);
    color: var(--text);
    border: 1px solid var(--line);
  }
  
  .btn-secondary:hover:not(:disabled) {
    background: rgba(255,255,255,0.12);
  }
  
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }

  /* ===== COMPACT LEGEND ===== */
  .legend {
    padding: 6px 8px;
    background: rgba(255,255,255,0.02);
    border-top: 1px solid var(--line);
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 8px;
    flex-shrink: 0;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 9px;
    color: var(--muted);
  }
  
  .legend-dot {
    width: 10px;
    height: 8px;
    border-radius: 2px;
    flex-shrink: 0;
  }
  
  .legend-dot.regular {
    background: rgba(255,255,255,0.15);
  }
  
  .legend-dot.vip {
    background: var(--vip);
  }
  
  .legend-dot.sweet {
    background: var(--sweet);
  }
  
  .legend-dot.available {
    background: rgba(76,175,80,0.6);
  }
  
  .legend-dot.booked {
    background: rgba(255,255,255,0.3);
  }
  
  .legend-dot.mine {
    background: var(--primary);
    box-shadow: 0 0 4px rgba(0,195,0,0.6);
  }
  
  /* ===== COMPACT STATS BAR ===== */
  .stats-bar {
    padding: 6px 8px;
    background: rgba(0,0,0,0.2);
    border-top: 1px solid var(--line);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
    flex-wrap: wrap;
  }
  
  .stat-item {
    font-size: 9px;
    color: var(--muted);
  }
  
  .stat-item strong {
    color: var(--text);
    font-weight: 700;
  }
  
  /* Loading */
  .loading {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
  }
  
  .loading-spinner {
    border: 3px solid rgba(255,255,255,0.1);
    border-top-color: var(--vip);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .already-booked-notice {
    background: rgba(0,195,0,0.1);
    border: 1px solid rgba(0,195,0,0.3);
    color: var(--primary);
    padding: 8px 12px;
    border-radius: 8px;
    margin: 8px;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
  }

  /* Larger screens adjustments */
  @media (min-width: 768px) {
    .seat {
      width: 24px;
      height: 24px;
    }
    
    .row-label {
      width: 20px;
      height: 20px;
      font-size: 11px;
    }
    
    .modal-content {
      border-radius: 16px;
      max-width: 420px;
      max-height: 90vh;
    }
    
    .modal {
      align-items: center;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <!-- User Header -->
    <div class="user-header">
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="" alt="User">
        <div class="user-details">
          <div class="user-name" id="userName">-</div>
          <div class="user-badge"><span id="userEmpNo">-</span> ‚Ä¢ <span id="userFactory">-</span></div>
        </div>
      </div>
      <button class="refresh-btn" onclick="refreshBookings()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>
    
    <!-- Event Header -->
    <div class="event-header">
      <div class="event-title">HRA Function 2025</div>
      <div class="event-name">CINEMA CLUB</div>
    </div>
    
    <!-- Already Booked Notice -->
    <div id="alreadyBookedNotice" class="already-booked-notice" style="display:none;">
      ‚úÖ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
    </div>
    
    <!-- Screen -->
    <div class="screen-container">
      <div class="screen"></div>
      <div class="screen-label">Screen</div>
    </div>
    
    <!-- Loading -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
    
    <!-- Seating Map -->
    <main class="seating-map" id="seatingMap" style="display:none;">
      <div class="seating-wrapper" id="seatingWrapper"></div>
    </main>
    
    <!-- Legend -->
    <footer class="legend">
      <div class="legend-item">
        <span class="legend-dot regular"></span>
        <span>Regular</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot sweet"></span>
        <span>Sweet</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot vip"></span>
        <span>VIP</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot available"></span>
        <span>‡∏ß‡πà‡∏≤‡∏á</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot booked"></span>
        <span>‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot mine"></span>
        <span>‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
      </div>
    </footer>
    
    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item">
        ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong><span id="statTotal">0</span>/170</strong>
      </div>
      <div class="stat-item">
        Regular: <strong id="statRegular">0</strong>
      </div>
      <div class="stat-item">
        Sweet: <strong id="statSweet">0</strong>
      </div>
      <div class="stat-item">
        VIP: <strong id="statVip">0</strong>
      </div>
    </div>
  </div>

  <!-- Book Modal -->
  <div id="bookModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</h3>
        <button class="modal-close" onclick="closeModal('bookModal')">&times;</button>
      </div>
      
      <div class="seat-preview">
        <div class="seat-preview-icon">üé¨</div>
        <div class="seat-preview-id" id="bookSeatId">-</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
        <div class="info-value" id="bookEmpNo">-</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</div>
        <div class="info-value" id="bookName">-</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</div>
        <div class="info-value" id="bookFactory">-</div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeModal('bookModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-primary" onclick="confirmBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div id="viewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
        <button class="modal-close" onclick="closeModal('viewModal')">&times;</button>
      </div>
      
      <div class="seat-preview">
        <div class="seat-preview-icon">üé´</div>
        <div class="seat-preview-id" id="viewSeatId">-</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
        <div class="info-value" id="viewEmpNo">-</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</div>
        <div class="info-value" id="viewName">-</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</div>
        <div class="info-value" id="viewFactory">-</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á</div>
        <div class="info-value" id="viewTime">-</div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeModal('viewModal')">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const API_URL = 'https://script.google.com/macros/s/AKfycbzDFe-UmxrioicKjQRQmha9XLmkBZlcpmRS2PstuwiynZmyWXlNOdpXGKYUSr2-UqOE/exec';
    
    // NEW LAYOUT: 170 seats total with more VIP
    const seatLayout = {
      'A': { count: 14, type: 'regular', split: 7 },   // 14 seats
      'B': { count: 14, type: 'regular', split: 7 },   // 14 seats
      'C': { count: 14, type: 'regular', split: 7 },   // 14 seats
      'D': { count: 14, type: 'regular', split: 7 },   // 14 seats
      'E': { count: 14, type: 'regular', split: 7 },   // 14 seats
      'F': { count: 14, type: 'regular', split: 7 },   // 14 seats
      'G': { count: 14, type: 'regular', split: 7 },   // 14 seats
      'H': { count: 14, type: 'regular', split: 7 },   // 14 seats = 112 Regular
      'S1': { count: 12, type: 'sweet', split: 6 },    // 12 seats
      'S2': { count: 12, type: 'sweet', split: 6 },    // 12 seats
      'S3': { count: 10, type: 'sweet', split: 5 },    // 10 seats = 34 Sweet  
      'V1': { count: 8, type: 'vip', split: 4 },       // 8 seats
      'V2': { count: 8, type: 'vip', split: 4 },       // 8 seats
      'V3': { count: 8, type: 'vip', split: 4 }        // 8 seats = 24 VIP
    };
    // Total: 112 + 34 + 24 = 170 seats
    
    let currentUser = null;
    let bookingsData = [];
    let myBooking = null;
    let selectedSeat = null;
    let isViewOnlyMode = false; // Track if user already has a booking
    
    // ==================== INITIALIZATION ====================
    window.onload = function() {
      if (!initUser()) return;
      
      // Show seating map immediately for testing, then try to load data
      renderSeats();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('seatingMap').style.display = 'flex';
      
      // Try to load actual data
      loadBookings();
    };
    
    function initUser() {
      const raw = sessionStorage.getItem('userData');
      if (!raw) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');
        window.location.href = 'index.html';
        return false;
      }
      
      try {
        const data = JSON.parse(raw);
        if (!data.empNo || !data.lineUserId) {
          throw new Error('Invalid user data');
        }
        
        currentUser = data;
        
        // Display user info
        document.getElementById('userName').textContent = data.name || '-';
        document.getElementById('userEmpNo').textContent = data.empNo || '-';
        document.getElementById('userFactory').textContent = data.factory || '-';
        
        if (data.linePictureUrl) {
          document.getElementById('userAvatar').src = data.linePictureUrl;
        } else {
          document.getElementById('userAvatar').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23ddd"/><text x="50" y="60" text-anchor="middle" font-size="40" fill="%23666">üë§</text></svg>';
        }
        
        return true;
        
      } catch (e) {
        console.error('User data error:', e);
        alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');
        window.location.href = 'index.html';
        return false;
      }
    }
    
    // ==================== API CALLS ====================
    async function apiGet(action, params = {}) {
      try {
        const url = new URL(API_URL);
        url.searchParams.append('action', action);
        
        for (const [key, value] of Object.entries(params)) {
          if (value !== undefined && value !== null && value !== '') {
            url.searchParams.append(key, value);
          }
        }
        
        const response = await fetch(url.toString());
        const data = await response.json();
        return data;
        
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }
    
    // ==================== DATA LOADING ====================
    async function loadBookings() {
      const loadingEl = document.getElementById('loading');
      const seatingMapEl = document.getElementById('seatingMap');
      
      loadingEl.style.display = 'block';
      seatingMapEl.style.display = 'none';
      
      try {
        // Clear old data first
        bookingsData = [];
        myBooking = null;
        
        // Use UID to get booking
        const [allBookings, myBookingData, stats] = await Promise.all([
          apiGet('getAllBookings'),
          apiGet('getMyBookingByUID', { lineUserId: currentUser.lineUserId }),
          apiGet('getBookingStats')
        ]);
        
        bookingsData = Array.isArray(allBookings) ? allBookings : [];
        myBooking = (myBookingData && myBookingData.seatId) ? myBookingData : null;
        
        // Set view-only mode if user already has booking
        isViewOnlyMode = !!myBooking;
        
        const noticeEl = document.getElementById('alreadyBookedNotice');
        if (isViewOnlyMode && noticeEl) {
          noticeEl.style.display = 'block';
        } else if (noticeEl) {
          noticeEl.style.display = 'none';
        }
        
        console.log('Loaded bookings:', bookingsData.length);
        console.log('My booking:', myBooking);
        console.log('View only mode:', isViewOnlyMode);
        
        renderSeats();
        updateStats(stats);
        
        loadingEl.style.display = 'none';
        seatingMapEl.style.display = 'flex';
        
      } catch (error) {
        console.error('Load error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
        loadingEl.style.display = 'none';
        
        // Show seating map even if there's an error
        renderSeats();
        seatingMapEl.style.display = 'flex';
      }
    }
    
    function refreshBookings() {
      loadBookings();
    }
    
    // ==================== RENDERING ====================
    function renderSeats() {
      try {
        const wrapper = document.getElementById('seatingWrapper');
        wrapper.innerHTML = '';
        
        const rows = Object.keys(seatLayout);
        const mySeatId = myBooking ? myBooking.seatId : null;
        
        console.log('Rendering seats for rows:', rows);
        console.log('My seat ID:', mySeatId);
        
        rows.forEach((rowId, index) => {
          const rowData = seatLayout[rowId];
          
          // Add dividers before Sweet and VIP sections
          if (rowId === 'S1' || rowId === 'V1') {
            const divider = document.createElement('div');
            divider.className = 'section-divider';
            wrapper.appendChild(divider);
          }
          
          const row = document.createElement('div');
          row.className = 'row';
          
          // Left label
          const labelLeft = document.createElement('span');
          labelLeft.className = 'row-label';
          if (rowData.type === 'vip') labelLeft.classList.add('vvip');
          if (rowData.type === 'sweet') labelLeft.classList.add('sweet');
          
          // Display label logic
          let displayLabel = rowId;
          if (rowId.startsWith('S')) displayLabel = 'S' + rowId.slice(1);
          if (rowId.startsWith('V')) displayLabel = 'VIP';
          
          labelLeft.textContent = displayLabel;
          row.appendChild(labelLeft);
          
          // Left block
          const blockLeft = document.createElement('div');
          blockLeft.className = 'seat-block';
          for (let i = 1; i <= rowData.split; i++) {
            const seatId = rowId + i;
            blockLeft.appendChild(createSeat(seatId, rowData.type, mySeatId));
          }
          row.appendChild(blockLeft);
          
          // Center aisle
          const aisle = document.createElement('div');
          aisle.className = 'center-aisle';
          row.appendChild(aisle);
          
          // Right block
          const blockRight = document.createElement('div');
          blockRight.className = 'seat-block';
          for (let i = rowData.split + 1; i <= rowData.count; i++) {
            const seatId = rowId + i;
            blockRight.appendChild(createSeat(seatId, rowData.type, mySeatId));
          }
          row.appendChild(blockRight);
          
          // Right label
          const labelRight = document.createElement('span');
          labelRight.className = 'row-label';
          if (rowData.type === 'vip') labelRight.classList.add('vvip');
          if (rowData.type === 'sweet') labelRight.classList.add('sweet');
          labelRight.textContent = displayLabel;
          row.appendChild(labelRight);
          
          wrapper.appendChild(row);
        });
        
        console.log('Seats rendered successfully');
        
      } catch (error) {
        console.error('Error rendering seats:', error);
        const wrapper = document.getElementById('seatingWrapper');
        wrapper.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</div>';
      }
    }
    
    function createSeat(seatId, type, mySeatId) {
      const seat = document.createElement('div');
      seat.className = 'seat ' + type;
      seat.setAttribute('data-seat-id', seatId);
      
      const booking = bookingsData.find(b => b.seatId === seatId);
      const isMine = (seatId === mySeatId);
      
      if (isMine) {
        seat.classList.add('mine');
        seat.onclick = () => viewMyBooking();
      } else if (booking) {
        seat.classList.add('booked');
        seat.onclick = () => viewBooking(booking);
      } else {
        // Available seat
        if (!isViewOnlyMode) {
          // Only clickable if user hasn't booked yet
          seat.classList.add('available');
          seat.onclick = () => openBookModal(seatId);
        }
        // If in view-only mode, empty seats are not clickable (no class, no onclick)
      }
      
      const seatInner = document.createElement('div');
      seatInner.className = 'seat-inner';
      seat.appendChild(seatInner);
      
      return seat;
    }
    
    function updateStats(stats) {
      if (!stats) return;
      
      document.getElementById('statTotal').textContent = stats.total || 0;
      document.getElementById('statRegular').textContent = stats.regular || 0;
      document.getElementById('statSweet').textContent = stats.sweet || 0;
      document.getElementById('statVip').textContent = stats.vip || 0;
    }
    
    // ==================== BOOKING FLOW ====================
    function openBookModal(seatId) {
      // This should only be called if user hasn't booked yet
      if (isViewOnlyMode) return;
      
      selectedSeat = seatId;
      
      document.getElementById('bookSeatId').textContent = seatId;
      document.getElementById('bookEmpNo').textContent = currentUser.empNo;
      document.getElementById('bookName').textContent = currentUser.name;
      document.getElementById('bookFactory').textContent = currentUser.factory;
      
      document.getElementById('bookModal').classList.add('active');
    }
    
    async function confirmBooking() {
      if (!selectedSeat || isViewOnlyMode) return;
      
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á...';
      
      try {
        const result = await apiGet('bookSeat', {
          empNo: currentUser.empNo,
          name: currentUser.name,
          factory: currentUser.factory,
          seatId: selectedSeat,
          lineUserId: currentUser.lineUserId
        });
        
        if (result.success) {
          alert('‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ' + selectedSeat + ' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ');
          closeModal('bookModal');
          await loadBookings(); // This will set view-only mode
        } else {
          alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + (result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
        }
        
      } catch (error) {
        console.error('Booking error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
      }
    }
    
    function viewBooking(booking) {
      // Show booking details - this should show the actual booking owner's info, not current user's info
      document.getElementById('viewSeatId').textContent = booking.seatId;
      document.getElementById('viewEmpNo').textContent = booking.empNo;
      document.getElementById('viewName').textContent = booking.name;
      document.getElementById('viewFactory').textContent = booking.factory;
      
      const bookingTime = new Date(booking.bookingTime);
      document.getElementById('viewTime').textContent = bookingTime.toLocaleString('th-TH');
      
      document.getElementById('viewModal').classList.add('active');
    }
    
    function viewMyBooking() {
      if (!myBooking) return;
      
      // Show my booking details
      document.getElementById('viewSeatId').textContent = myBooking.seatId;
      document.getElementById('viewEmpNo').textContent = myBooking.empNo;
      document.getElementById('viewName').textContent = myBooking.name;
      document.getElementById('viewFactory').textContent = myBooking.factory;
      
      const bookingTime = new Date(myBooking.bookingTime);
      document.getElementById('viewTime').textContent = bookingTime.toLocaleString('th-TH');
      
      document.getElementById('viewModal').classList.add('active');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
      selectedSeat = null;
    }
    
    // Close modal on background click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
          selectedSeat = null;
        }
      });
    });
  </script>
</body>
</html>
